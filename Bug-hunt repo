#!/bin/bash
set -e

# Download and extract Android NDK (if not present)
NDK_VERSION="r25c"
NDK_URL="https://dl.google.com/android/repository/android-ndk-${NDK_VERSION}-linux.zip"
NDK_DIR="$HOME/android-ndk-${NDK_VERSION}"

if [ ! -d "$NDK_DIR" ]; then
    echo "Downloading Android NDK $NDK_VERSION..."
    wget "$NDK_URL" -O /tmp/android-ndk.zip
    unzip /tmp/android-ndk.zip -d $HOME
fi

export NDK="$NDK_DIR"
export PATH="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"

# Clone su source and build for armv7
if [ ! -d superuser ]; then
    git clone https://github.com/phhusson/superuser.git
fi
cd superuser/su
armv7a-linux-androideabi21-clang su.c -o su-armv7

echo "su binary built at $(pwd)/su-armv7"

adb push su-armv7 /data/local/tmp/su